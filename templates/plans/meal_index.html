{% extends "base.html" %}
{% block content %}
<h2>üçΩÔ∏è Weekly Meal Planner</h2>
<div style="display: flex; gap: 2rem;">

<!-- Left Column: Planner -->
<div style="flex: 1;">
  {% set days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'] %}
  {% set slots = ['Breakfast','Lunch','Snack','Dinner'] %}
  {% for d in days %}
    <h3 style="margin-top:1.5rem;">{{ d }}</h3>
    {% for slot in slots %}
      <h4>{{ slot }}</h4>
        <ul>
        {% for m in meals if m.day == d and m.meal_type == slot %}
            <li>
                <strong>{{ m.name }}</strong>
        <ul>
        {% for ing in m.ingredients %}
            <li>{{ ing.grams }}g {{ ing.name }} ‚Äî {{ ing.calories }} kcal, {{ ing.protein }}P / {{ ing.carbs }}C / {{ ing.fat }}F</li>
        {% endfor %}
        </ul>
            <strong>Total:</strong> {{ m.totals.calories }} kcal, {{ m.totals.protein }}P / {{ m.totals.carbs }}C / {{ m.totals.fat }}F
            <form action="{{ url_for('meal_plans.delete_meal', meal_id=m.id) }}"
                method="POST" style="display:inline;">
            <button style="border:none;color:#d00;background:none;">‚úï</button>
        </form>

      <!-- Add Ingredient to Meal -->
        <form action="{{ url_for('meal_plans.add_ingredient') }}" method="POST" style="margin-top: 0.5rem;">
            <input type="hidden" name="meal_id" value="{{ m.id }}">
            <select name="ingredient_id">
            {% for i in ingredients %}
                <option value="{{ i.id }}">{{ i.name }}</option>
            {% endfor %}
            </select>
                <input name="grams" type="number" step="any" placeholder="grams" required>
                <button>Add</button>
        </form>
            </li>
                {% else %}
            <li><em>No meal yet.</em></li>
                {% endfor %}
        </ul>

      <form action="{{ url_for('meal_plans.add_meal') }}" method="POST" style="margin-bottom:1rem;">
        <input type="hidden" name="day" value="{{ d }}">
        <input type="hidden" name="meal_type" value="{{ slot }}">
        <input type="text" name="name" placeholder="Meal name" required><br>

        <div class="ingredients-container">
          <div class="ingredient-row">
            <input type="text" name="ingredient_name" placeholder="Ingredient name" required>
            <input type="number" name="ingredient_grams" step="any" placeholder="Grams" required>
          </div>
        </div>
        <button type="button" onclick="addIngredientRow(this)">‚ûï Add Ingredient</button><br>
        <button type="submit">üíæ Add Meal</button>
      </form>
    {% endfor %}
  {% endfor %}
</div>

<!-- Right Column: Ingredients -->
<div style="flex: 1;">
  <h3>üßÆ Ingredient Reference</h3>
  <form method="POST" action="{{ url_for('ingredients.manage_ingredients') }}" style="margin-bottom: 1rem;">
    <input name="name" placeholder="Ingredient name" required>
    <input name="calories" type="number" step="any" placeholder="kcal/100g" required>
    <input name="protein" type="number" step="any" placeholder="protein/100g" required>
    <input name="carbs" type="number" step="any" placeholder="carbs/100g" required>
    <input name="fat" type="number" step="any" placeholder="fat/100g" required>
    <button>Add Ingredient</button>
  </form>

  <ul>
    {% for i in ingredients %}
      <li>
        <strong>{{ i.name }}</strong> ‚Äì {{ i.calories }} kcal, {{ i.protein }}P / {{ i.carbs }}C / {{ i.fat }}F per 100g
      </li>
    {% endfor %}
  </ul>

  <h4 style="margin-top:1.5rem;">üß† Macro Calculator</h4>
  <form action="{{ url_for('ingredients.calculate_macros') }}" method="POST">
    <input type="text" name="name" placeholder="Ingredient name" required>
    <input type="number" step="any" name="grams" placeholder="Grams" required>
    <button type="submit">Calculate</button>
  </form>
  {% if result %}
    <h4>Calculated Macros for {{ result.grams }}g of {{ result.name }}</h4>
    <ul>
      <li>Calories: {{ result.calories }}</li>
      <li>Protein: {{ result.protein }} g</li>
      <li>Carbs: {{ result.carbs }} g</li>
      <li>Fat: {{ result.fat }} g</li>
    </ul>
  {% endif %}
</div>
</div>

<script>
function addIngredientRow(button) {
  const container = button.previousElementSibling;
  const row = document.createElement("div");
  row.className = "ingredient-row";
  row.innerHTML = `
    <input type="text" name="ingredient_name" placeholder="Ingredient name" required>
    <input type="number" name="ingredient_grams" step="any" placeholder="Grams" required>
  `;
  container.appendChild(row);
}
</script>

{% endblock %}
